/* RemoteDataLists v3.2 2019 Copyright Tomasz Kunicki, AdRem Software, all rights reserved */
(function(global,factory){"use strict";if(typeof define==="function"&&define.amd){define("remoteDataLists",["client"],function(adrem){factory(adrem);return adrem.RemoteDataListStore})}else{factory(global.adrem)}})(typeof window==="undefined"?global:window,function(adrem){"use strict";(function(adrem){const E_DATA_CHANGED=0,E_PROPERTIES_CHANGED=1,E_DATA_CHANGED_WITH_DATA=2,ENC_DEBUG="debug",ENC_WORK="work",ENC_REC="rec",ENC_OBJ="obj",asArray=function(data){return Array.isArray(data)?data:[data]},decodeRecordData=function(encoding,model,data,values){let len,i,ix,val;function fixDateField(fieldType,val){if(model.owner.autoDecodeDates&&fieldType===2&&typeof val==="string"){if(Date.create!=null){return Date.create(val)}else{return new Date(val)}}return val}if(encoding===ENC_DEBUG){model.fields.forEach((field,i)=>{const val=data[field.FieldName];if(val!==undefined){values[i]=fixDateField(model.fields[i].FieldType,val)}})}else{if(data[0]==="R"){len=model.fields.length;for(i=0;i<len;i++){values[i]=fixDateField(model.fields[i].FieldType,data[i+1])}}else if(data[0]==="C"){len=data.length;for(i=1;i<len;){ix=data[i++];val=data[i++];values[ix]=fixDateField(model.fields[ix].FieldType,val)}}}},decodeRecordKey=function(encoding,model,data){let i,ix,val,keyIx=model.keyIx;if(encoding===ENC_DEBUG){return data[model.key]}else{if(data[0]==="R"){return data[keyIx+1]}else{for(i=data.length-1;i>0;){val=data[i--];ix=data[i--];if(ix===keyIx){return val}}}}return null},DataListPropertyGroup=function DataListPropertyGroup(owner,cfg){const values={};let changes={},_get=function(p){return function(){let v=changes[p];if(v===undefined){v=values[p]}return v}},_set=function(p){return function(val){changes[p]=val;owner.fireEvent("property-changed",{name:p,value:val})}};this.getChanges=function(){return changes};this.clearChanges=function(){adrem.extend(values,changes);changes={}};this.getValues=function(){return values};this.update=function(cfg){Object.keys(cfg).forEach(function(p){if(values[p]!==cfg[p]){values[p]=cfg[p];if(!this.hasOwnProperty(p)){Object.defineProperty(this,p,{get:_get(p),set:_set(p),configurable:true,enumerable:true})}owner.fireEvent("property-changed",{name:p,value:values[p]})}},this);changes={}};this.isChanged=function(){return Object.keys(changes).length>0};this.update(cfg)},localFieldAdapter={_getByIx(ix){const privateData=this._owner_._private_;return privateData.changes[ix]!==undefined?privateData.changes[ix]:privateData.values[ix]},_setByIx(ix,val){const privateData=this._owner_._private_;privateData.changes[ix]=val;this._owner_.touch();privateData.model.notifyRecChanged(this._owner_)}},DataListRecordFieldAdapter=function DataListRecordFieldAdapter(model){function _get(ix){return function(){return localFieldAdapter._getByIx.call(this,ix)}}function _set(ix){return function(value){return localFieldAdapter._setByIx.call(this,ix,value)}}model.fields.forEach(function(field,i){Object.defineProperty(this,field.FieldName,{set:_set(i),get:_get(i),configurable:true,enumerable:true})},this);this.getByIndex=function(ix){return localFieldAdapter._getByIx.call(this,ix)}},CreateDataListRecordValues=function(model){const Constructor=function DataListRecordValues(owner){Object.defineProperty(this,"_owner_",{value:owner,configurable:true})};Constructor.prototype=new DataListRecordFieldAdapter(model);return Constructor},DataListRecord=function(){const toJson=typeof window!=="undefined"&&window.angular!=null?angular.toJson:JSON.stringify;function isObjectChanged(jsonRef,jsonObj){if(jsonRef!==jsonObj){return!adrem.deepEqual(JSON.parse(jsonRef),JSON.parse(jsonObj))}else{return false}}const Constructor=function DataListRecord(model,encoding,cfg){let i,fields,val;const _private={key:undefined,values:[],changes:[],refs:[],model:model};Object.defineProperty(this,"_private_",{value:_private});this.values=new model.DataListValues(this);this.local={};this.lid=model.owner.lid;model.owner.lid+=1;fields=this._private_.model.fields;if(encoding===ENC_DEBUG){for(i=fields.length-1;i>=0;i--){_private.values[i]=cfg[fields[i].FieldName];_private.changes[i]=undefined}}else if(encoding===ENC_OBJ){for(i=fields.length-1;i>=0;i--){_private.values[i]=undefined;_private.changes[i]=cfg[fields[i].FieldName];if(i===this._private_.model.keyIx){_private.values[i]=_private.changes[i]}}}else if(encoding===ENC_REC){for(i=fields.length-1;i>=0;i--){_private.values[i]=cfg._private_.values[i];_private.changes[i]=cfg._private_.changes[i]}}else{this.update(encoding,cfg)}if(model.owner.objChangeDetection){for(i=fields.length-1;i>=0;i--){if(_private.changes[i]===undefined){val=_private.values[i];if(typeof val==="object"){_private.refs.push({ix:i,val:toJson(val)})}}}}_private.key=_private.values[this._private_.model.keyIx];if(this.getKey()!==undefined&&encoding!==ENC_OBJ){_private.changed=_private.model.getChangeStamp();_private.serverRev=_private.changed}else{this.touch()}};adrem.extend(Constructor.prototype,{getKey(){return this._private_.key},unlink(){Object.defineProperty(this,"_owner_",{value:undefined});delete this.values},setKey(key){if(this._private_.key===undefined){this._private_.values[this._private_.model.keyIx]=key;this._private_.key=key}else{throw new Error("Invalid attempt to change record key.")}},hasKey(){return this._private_.key!==undefined},isChanged(since){let i,ref;if(since===undefined){since=this._private_.serverRev||0}if(this._private_.model.owner.objChangeDetection){if(this._private_.refs.length>0){for(i=this._private_.refs.length-1;i>=0;i-=1){ref=this._private_.refs[i];if(this._private_.changes[ref.ix]!==undefined){if(!isObjectChanged(ref.val,toJson(this._private_.changes[ref.ix]))){this._private_.changes[ref.ix]=undefined}else{this._private_.refs.splice(i,1)}}else{if(isObjectChanged(ref.val,toJson(this._private_.values[ref.ix]))){this._private_.changes[ref.ix]=this._private_.values[ref.ix];this._private_.refs.splice(i,1);this.touch()}}}}}return this._private_.changed>since},getValues(){let values={},i,fields,fname;fields=this._private_.model.fields;for(i=fields.length-1;i>=0;i--){fname=fields[i].FieldName;values[fname]=this.values[fname]}return values},getChanges(){let res={},key=this.getKey(),hasChanges=false;this._private_.model.fields.forEach((field,i)=>{if(field.FieldData.Attributes!==2){if(this._private_.changes[i]!==undefined){res[field.FieldName]=this._private_.changes[i];hasChanges=true}else if(key===undefined){res[field.FieldName]=this._private_.values[i];hasChanges=true}}});if(hasChanges){res[this._private_.model.key]=key;return res}else{return null}},clearChanges(){if(this._private_.changed>this._private_.serverRev){for(let i=this._private_.changes.length-1;i>=0;i--){this._private_.changes[i]=undefined}this._private_.changed=this._private_.serverRev}},remove(){this._private_.model.owner.delByRec(this)},update(encoding,data){decodeRecordData(encoding,this._private_.model,data,this._private_.values);this.clearChanges();this._private_.serverRev=this._private_.model.getChangeStamp();this._private_.changed=this._private_.serverRev},touch(){this._private_.changed=this._private_.model.getChangeStamp()}});return Constructor}(),DataListModel=function(){function DataListModel(owner,data){adrem.extend(this,data);this.owner=owner;this.keyIx=-1;this.changeRevision=0;this.DataListValues=new CreateDataListRecordValues(this);this.keyIx=this.fields.findIndex(f=>f.FieldName===this.key)}adrem.extend(DataListModel.prototype,{finalize(){delete this.DataListValues},newRecord(encoding,cfg){return new DataListRecord(this,encoding,cfg)},getChangeStamp(){this.changeRevision+=1;return this.changeRevision},notifyRecChanged(rec){this.owner.notifyChanged(rec)}});return DataListModel}(),RemoteDataListStore=function(){function onClientEvent(e){if(e.eventid===E_DATA_CHANGED){this.needsRefresh=true}else if(e.eventid===E_PROPERTIES_CHANGED){this.needsRefreshProperties=true}else if(e.eventid===E_DATA_CHANGED_WITH_DATA){this.fastRefresh=false;this.doRefresh(e.data)}if(this.fastRefresh){this.fastRefresh=false;this.refresh()}}const Constructor=function RemoteDataListStore(api,minRefTime,connection){const self=this;let minRefreshTime=minRefTime!=null&&typeof minRefTime==="number"?minRefTime:350;let autoTimer;this.map=new Map;this.data=[];this.deleted=[];this.needsRefresh=false;this.fastRefresh=false;this.needsRefreshProperties=false;this.updating=0;this.suppressedChangedNotification=false;this.propertyupdating=false;this.dataEncoding=adrem.debug?ENC_DEBUG:ENC_WORK;this.objChangeDetection=false;this.autoDecodeDates=false;this.lid=1;this.refreshOnInvisible=adrem.isNodeJS;function autoRefresh(){if(!self.refreshOnInvisible&&!adrem.isVisible){autoTimer=null;return}if(self.needsRefresh||self.needsRefreshProperties){self.refresh()}self.commitProperties();if(minRefreshTime>0&&(self.refreshOnInvisible||adrem.isVisible)){autoTimer=setTimeout(autoRefresh,minRefreshTime)}else{autoTimer=null}}Object.defineProperty(this,minRefreshTime,{get(){return minRefreshTime},set(value){minRefreshTime=value;if(autoTimer==null){autoRefresh()}else if(minRefreshTime<0){clearTimeout(autoTimer);autoTimer=null}}});if(connection==null&&typeof minRefTime==="object"){connection=minRefTime}this.connection=connection||adrem;this.properties={beginUpdate(){self.propertyupdating=true},endUpdate(){self.propertyupdating=false}};this.remoteData=new this.connection[api].IDataListStore({dataFormat:this.dataEncoding});this.connection.Client.on(this.remoteData.id,onClientEvent,this);if(!adrem.isNodeJS){adrem.Client.on("$visible",function(visible){if(visible&&autoTimer==null){autoRefresh()}})}Constructor.inherited.constructor.call(this);if(minRefreshTime>=0){autoRefresh()}};adrem.inherit(Constructor,adrem.EventManager);adrem.extend(Constructor.prototype,{deleteProperties(){Object.keys(this.properties).forEach(key=>delete this.properties[key])},finalize(){if(this.remoteData!=null){this.connection.Client.un(this.remoteData.id,onClientEvent,this);this.remoteData.destroy();delete this.remoteData}this.deleteProperties();if(this.model!=null){this.model.finalize();delete this.model}},notifyChanged(data){if(this.updating===0){if(data!==undefined){this.fireEvent("record-changed",data)}this.fireEvent("changed")}else{this.suppressedChangedNotification=true}},notifyDeleted(data){if(this.updating===0){this.fireEvent("record-deleted",data);this.fireEvent("changed")}else{if(this.deleted.indexOf(data)<0){this.suppressedDeletes.push(data)}}},perform(...args){return this.remoteData.perform(...args)},asyncPerform(...args){return this.remoteData.perform.asTask(...args)},beginUpdate(){if(this.updating===0){this.suppressedChangedNotification=false;this.suppressedDeletes=[];if(this.model!=null){this.updateRevision=this.model.getChangeStamp()-1}}this.updating+=1},endUpdate(force){let changed=[],deleted=[];this.updating-=1;if(this.updating===0&&(this.suppressedChangedNotification||force===true)){if(this.hasListener("record-changed")){changed=this.data.filter(function(rec){return rec.isChanged(this.updateRevision)},this)}if(this.hasListener("record-deleted")){deleted=this.deleted.filter(rec=>rec._private_.deleted>this.updateRevision);deleted=deleted.concat(this.suppressedDeletes);this.suppressedDeletes=[]}if(changed.length>0){this.notifyChanged(changed)}else{this.notifyChanged()}if(deleted.length>0){this.notifyDeleted(deleted);deleted.forEach(rec=>{if(rec.unlink!==undefined){rec.unlink()}});deleted=[]}}},destroy(){this.minRefreshTime=-1;this.close();this.finalize()},close(force){force=force!=null?force:true;if(this.model!==undefined){this.model.finalize();delete this.model}if(force&&this.remoteData!=null){this.remoteData.close()}this.deleteProperties();this.data.length=0;this.map.clear()},open(tableName,query,callback,scope){query=query||"";this.close(false);this.tableName=tableName;this.remoteData.open(tableName,query,function(response){if(response==null){console.error("Can't open table: ",tableName);if(callback!=null){callback.call(scope,null)}return}if(response.model==null&&response.key!=null||response.fields!=null){response={model:response}}if(response.model!=null&&response.model.fields!=null){this.model=new DataListModel(this,response.model)}scope=scope||this;if(response.data!=null){if(callback!==undefined){callback.call(scope,this.data)}this.needsRefresh=false;this.doRefresh(response.data);this.fireEvent("open",this);this.notifyChanged()}else{this.needsRefresh=true;this.refresh(function(){if(callback!==undefined){callback.call(scope,this.data)}this.fireEvent("open",this);this.notifyChanged()})}if(response.properties!=null){this.doUpdateProperties(response.properties)}else{this.readProperties(true)}},this)},getValues(){return this.data.map(rec=>rec.getValues())},getByKey(key){return this.map.get(key)},delByIndex(ix,count){let i,startix;if(ix<this.data.length){startix=ix+count;if(startix>=this.data.length){startix=this.data.length-1}for(i=startix;i>=ix;i-=1){this.delByRec(this.data[i])}}},delByRec(rec,permanent){let key;if(permanent===undefined){permanent=false}if(rec!==undefined){key=rec.getKey();if(key!=null){this.map.delete(key)}this.data.splice(this.data.indexOf(rec),1);if(key!==undefined&&!permanent){rec._private_.deleted=this.model.getChangeStamp();this.deleted.push(rec)}this.notifyDeleted(rec);this.notifyChanged()}},delByKey(key){if(key!==undefined){this.delByRec(this.map.get(key))}},addRecord(rec){this.data.push(rec);if(rec.getKey()!==undefined){this.map.set(rec.getKey(),rec)}this.notifyChanged(rec);return rec},getRecCopy(rec){return this.model.newRecord(ENC_REC,rec)},add(cfg){return this.addRecord(this.model.newRecord(ENC_OBJ,cfg))},clear(callback){this.revert();this.remoteData.clear(()=>{const deleted=this.data.slice();this.data.length=0;this.map.clear();this.deleted=[];if(deleted.length>0){this.notifyDeleted(deleted);this.notifyChanged()}this.fireEvent("clear",this);if(callback!=null&&typeof callback==="function"){callback()}})},doUpdateProperties(data){data.forEach(prop=>{if(!this.properties.hasOwnProperty(prop.group)){this.properties[prop.group]=new DataListPropertyGroup(this,prop.properties)}else{this.properties[prop.group].update(prop.properties)}this.fireEvent("property-group-changed",prop.group,this.properties[prop.group])})},readProperties(doread){if(doread&&this.remoteData!=null){this.needsRefreshProperties=false;this.remoteData.getProperties(data=>this.doUpdateProperties(data))}},commitProperties(){let v,p,changes=[];if(this.propertyupdating===false){for(p in this.properties){if(this.properties.hasOwnProperty(p)){v=this.properties[p];if(v.isChanged!==undefined&&v.isChanged()){changes.push({group:p,properties:v.getChanges()});v.clearChanges()}}}if(changes.length>0){this.remoteData.setProperties(changes)}}},refresh(callback){this.readProperties(this.needsRefreshProperties);if(this.needsRefresh){this.needsRefresh=false;if(this.remoteData!=null){this.remoteData.refresh(data=>{this.doRefresh(data);if(callback!==undefined){callback.call(this)}})}}else{this.fastRefresh=true}},internalDoRefresh(data){let i,ix,delMap={},delKeys=[],key,newRec,oldRec,rec;if(data.reload){this.data.length=0;this.map.clear()}if(this.deleted.length>0){this.deleted.forEach(function(rec,i){delMap[rec.getKey()]=i},this)}if(data.updates!==undefined&&this.model!=null){const updates=Array.isArray(data.updates)?data.updates:[data.updates];for(i=updates.length-1;i>=0;i--){newRec=updates[i];key=decodeRecordKey(this.dataEncoding,this.model,newRec);oldRec=this.map.get(key);if(oldRec!==undefined){oldRec.update(this.dataEncoding,newRec);this.notifyChanged(oldRec)}else{ix=delMap[key];if(ix!==undefined){this.deleted[ix].update(this.dataEncoding,newRec)}else{this.addRecord(this.model.newRecord(this.dataEncoding,newRec))}}}}if(data.deletes!==undefined){const updates=Array.isArray(data.deletes)?data.deletes:[data.deletes];for(i=updates.length-1;i>=0;i--){key=updates[i];rec=this.map.get(key);if(rec!==undefined){this.delByRec(this.map.get(key),true)}else{ix=delMap[key];if(ix!==undefined){delKeys.push(ix)}}if(delKeys.length>0){delKeys.sort(function(a,b){return b-a});delKeys.forEach(function(ix){this.deleted.splice(ix,1)},this)}}}},doRefresh(data){if(data!=null&&data.success){this.beginUpdate();if(data.fields!=null){this.model=new DataListModel(this,{key:data.key,fields:data.fields})}try{this.internalDoRefresh(data)}finally{this.endUpdate(true);if(data.markers!=null){asArray(data.markers).forEach(m=>this.fireEvent("change-marker",m))}}}},getLocalChanges(){const result={changes:[]};result.changedRecords=this.data.filter(rec=>{let changes;if(rec.isChanged()){changes=rec.getChanges();if(changes!=null){result.changes.push(changes);return true}return false}else{return false}});result.deleted=this.deleted.map(rec=>rec.getKey());return result},isChanged(){const log=this.getLocalChanges();return log.changes.length+log.deleted.length>0},commitNode(node,callback){if(typeof node==="number"){node=this.getByKey(node)}if(node.isChanged()){this.remoteData.update([node.getChanges()],()=>{if(typeof callback==="function"){callback()}})}else{if(typeof callback==="function"){callback()}}},commit(callback){const changeLog=this.getLocalChanges();let changed=false,called=false;this.deleted=[];if(changeLog.deleted.length>0){this.remoteData.remove(changeLog.deleted);changed=true}if(changeLog.changes.length>0){changed=true;called=true;this.remoteData.update(changeLog.changes,function(keys){keys=asArray(keys);changeLog.changedRecords.forEach((crec,i)=>{if(i<keys.length){if(crec.getKey()===undefined){crec.setKey(keys[i]);this.map.set(keys[i],crec)}}});if(callback!=null&&typeof callback==="function"){callback()}},this)}if(changed){this.fireEvent("commit",this);this.refresh()}if(!called&&typeof callback==="function"){callback()}},revert(){for(let i=this.data.length-1;i>=0;i--){if(this.data[i].getKey()===undefined){this.data.splice(i,1)}else if(this.data[i].isChanged()){this.data[i].clearChanges()}}this.deleted.forEach(rec=>{if(rec.isChanged()){rec.clearChanges()}this.addRecord(rec)});this.deleted=[];this.fireEvent("revert",this);this.notifyChanged()}});return Constructor}();adrem.deepEqual=function(){const pSlice=Array.prototype.slice,objectKeys=Object.keys;function isArguments(object){return Object.prototype.toString.call(object)==="[object Arguments]"}function deepEqual(actual,expected,opts){opts=opts||{};if(actual===expected){return true}else if(actual instanceof Date&&expected instanceof Date){return actual.getTime()===expected.getTime()}else if(!actual||!expected||typeof actual!=="object"&&typeof expected!=="object"){return opts.strict?actual===expected:actual==expected}else{return objEquiv(actual,expected,opts)}}function isUndefinedOrNull(value){return value===null||value===undefined}function isBuffer(x){if(!x||typeof x!=="object"||typeof x.length!=="number"){return false}if(typeof x.copy!=="function"||typeof x.slice!=="function"){return false}return!(x.length>0&&typeof x[0]!=="number")}function objEquiv(a,b,opts){let i,key,ka,kb;if(isUndefinedOrNull(a)||isUndefinedOrNull(b)){return false}if(a.prototype!==b.prototype){return false}if(isArguments(a)){if(!isArguments(b)){return false}a=pSlice.call(a);b=pSlice.call(b);return deepEqual(a,b,opts)}if(isBuffer(a)){if(!isBuffer(b)){return false}if(a.length!==b.length){return false}for(i=0;i<a.length;i++){if(a[i]!==b[i]){return false}}return true}try{ka=objectKeys(a);kb=objectKeys(b)}catch(e){return false}if(ka.length!==kb.length){return false}ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!==kb[i]){return false}}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!deepEqual(a[key],b[key],opts)){return false}}return typeof a===typeof b}return deepEqual}();adrem.RemoteDataListStore=RemoteDataListStore;if(typeof module==="object"){module.exports=RemoteDataListStore}})(adrem)});